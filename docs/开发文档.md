# 医疗陪诊Agent - 开发文档

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────┐
│                   用户层                         │
│  (微信小程序 / 手机App / Web界面)                │
└───────────────────┬─────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────┐
│                 API网关层                        │
│              (FastAPI + CORS)                   │
└───────────────────┬─────────────────────────────┘
                    │
        ┌───────────┼───────────┐
        │           │           │
┌───────▼───┐ ┌────▼────┐ ┌───▼─────┐
│ 用户管理  │ │预约管理 │ │指导管理 │
│   API     │ │   API   │ │   API   │
└───────┬───┘ └────┬────┘ └───┬─────┘
        │          │          │
┌───────▼──────────▼──────────▼─────┐
│           Agent智能层               │
│  ┌──────────┐  ┌──────────┐       │
│  │症状分析  │  │预约Agent │       │
│  │ Agent    │  │          │       │
│  └──────────┘  └──────────┘       │
│  ┌──────────┐  ┌──────────┐       │
│  │指导Agent │  │用药指导  │       │
│  │          │  │ Agent    │       │
│  └──────────┘  └──────────┘       │
└───────────────┬────────────────────┘
                │
┌───────────────▼────────────────────┐
│            数据层                   │
│  ┌──────────┐  ┌──────────┐       │
│  │SQLAlchemy│  │ MongoDB  │       │
│  │(用户数据)│  │(就医记录)│       │
│  └──────────┘  └──────────┘       │
└────────────────────────────────────┘
```

### 核心模块说明

#### 1. Agent智能层

**SymptomAnalyzer (症状分析Agent)**
- 功能：分析患者症状，推荐就诊科室
- 技术：OpenAI GPT-4
- 输入：症状描述、患者信息
- 输出：推荐科室、紧急程度、就医建议

**AppointmentAgent (预约挂号Agent)**
- 功能：自动化预约挂号流程
- 接口：医院预约系统API
- 功能：搜索医院、查询号源、创建预约、取消预约

**GuidanceAgent (就医指导Agent)**
- 功能：提供就医全流程指导
- 特点：分步骤、个性化、语音支持
- 流程：挂号→候诊→就诊→检查→缴费→取药

**MedicationGuide (用药指导Agent)**
- 功能：用药指导和提醒管理
- 技术：AI处方解析、药物数据库
- 功能：处方解析、用药说明、时间表、提醒

#### 2. 数据模型

**User (用户表)**
```python
- id: 用户ID
- name: 姓名
- phone: 手机号
- age: 年龄
- gender: 性别
- medical_history: 病史
- allergies: 过敏史
- chronic_diseases: 慢性病
- emergency_contact: 紧急联系人
```

**Appointment (预约表)**
```python
- id: 预约ID
- user_id: 用户ID
- hospital_name: 医院名称
- department: 科室
- appointment_date: 预约时间
- appointment_number: 预约号
- status: 状态
```

**MedicalRecord (就医记录表)**
```python
- id: 记录ID
- user_id: 用户ID
- visit_date: 就诊日期
- diagnosis: 诊断结果
- prescriptions: 处方信息
- examinations: 检查项目
```

## API接口文档

### 基础信息

- **Base URL**: `http://localhost:8000`
- **API版本**: v1.0
- **响应格式**: JSON
- **字符编码**: UTF-8

### 用户管理API

#### POST /api/users/
创建新用户

**请求体**:
```json
{
  "name": "string",
  "phone": "string",
  "age": 70,
  "gender": "男",
  "emergency_contact_name": "string",
  "emergency_contact_phone": "string"
}
```

**响应**:
```json
{
  "id": 1,
  "name": "string",
  "phone": "string",
  "age": 70,
  "gender": "男"
}
```

#### GET /api/users/{user_id}
获取用户信息

#### GET /api/users/phone/{phone}
通过手机号查询用户

### 预约管理API

#### POST /api/appointments/analyze-symptoms
症状分析

**请求体**:
```json
{
  "user_id": 1,
  "symptoms": "头晕、心慌"
}
```

**响应**:
```json
{
  "success": true,
  "recommended_department": "心血管内科",
  "urgency": "semi-urgent",
  "advice": "建议尽快就医...",
  "ai_analysis": "完整的AI分析结果"
}
```

#### GET /api/appointments/hospitals
搜索医院

**查询参数**:
- location: 地理位置
- department: 科室（可选）

#### POST /api/appointments/
创建预约

### 就医指导API

#### GET /api/guidance/appointment/{appointment_id}/full
获取完整就医指导

#### POST /api/guidance/step
获取当前步骤指导

**请求体**:
```json
{
  "user_id": 1,
  "appointment_id": 1,
  "current_step": "registration"
}
```

#### GET /api/guidance/voice/{step}
获取语音指导文本

### 用药管理API

#### POST /api/medications/parse-prescription
解析处方

#### POST /api/medications/instructions
获取用药说明

#### POST /api/medications/schedule
创建用药时间表

#### POST /api/medications/reminders
生成用药提醒

## 扩展开发指南

### 添加新的Agent

1. 在 `agents/` 目录创建新的Agent类
2. 继承基础Agent类（如需要）
3. 实现核心方法
4. 在 `agents/__init__.py` 中导出

示例：
```python
# agents/new_agent.py
from loguru import logger

class NewAgent:
    def __init__(self):
        logger.info("NewAgent initialized")
    
    def process(self, data):
        # 实现处理逻辑
        pass
```

### 添加新的API端点

1. 在 `api/` 目录创建新的路由文件
2. 定义Pydantic模型
3. 实现API端点
4. 在 `api/main.py` 中注册路由

示例：
```python
# api/new_feature.py
from fastapi import APIRouter
from pydantic import BaseModel

router = APIRouter()

class RequestModel(BaseModel):
    field: str

@router.post("/endpoint")
async def new_endpoint(request: RequestModel):
    return {"result": "success"}
```

### 集成新的医院系统

1. 在 `agents/appointment_agent.py` 中添加医院适配器
2. 实现医院特定的API调用
3. 统一返回格式

```python
class HospitalAdapter:
    def __init__(self, hospital_id):
        self.hospital_id = hospital_id
        self.api_config = self._get_hospital_config(hospital_id)
    
    def search_slots(self, department, date):
        # 调用医院API
        pass
    
    def make_appointment(self, user_info, slot_info):
        # 创建预约
        pass
```

### 自定义AI模型

如果不想使用OpenAI，可以替换为其他模型：

```python
# agents/symptom_analyzer.py
from your_ai_library import YourAI

class SymptomAnalyzer:
    def __init__(self):
        # 使用自定义模型
        self.model = YourAI()
    
    def analyze_symptoms(self, symptoms, patient_info):
        # 使用自定义模型进行分析
        result = self.model.analyze(symptoms)
        return result
```

## 测试

### 单元测试

```bash
pytest tests/test_agents.py
```

### API测试

```bash
pytest tests/test_api.py
```

### 测试覆盖率

```bash
pytest --cov=agents --cov=api tests/
```

## 部署

### Docker部署

创建 `Dockerfile`:
```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

CMD ["python", "api/main.py"]
```

构建和运行:
```bash
docker build -t medical-escort .
docker run -p 8000:8000 medical-escort
```

### 生产环境配置

1. 使用PostgreSQL代替SQLite
2. 配置HTTPS
3. 设置环境变量
4. 配置日志轮转
5. 设置监控告警

## 性能优化

1. **数据库优化**
   - 添加索引
   - 使用连接池
   - 查询优化

2. **缓存策略**
   - Redis缓存热点数据
   - 缓存医院信息
   - 缓存AI分析结果

3. **异步处理**
   - 使用异步IO
   - 后台任务队列
   - 消息队列

## 安全考虑

1. **API认证**
   - JWT token
   - API Key
   - OAuth2

2. **数据加密**
   - 传输加密(HTTPS)
   - 存储加密
   - 敏感信息脱敏

3. **权限控制**
   - RBAC角色权限
   - 操作审计
   - 访问日志

## 监控和日志

### 日志级别
- DEBUG: 调试信息
- INFO: 一般信息
- WARNING: 警告
- ERROR: 错误
- CRITICAL: 严重错误

### 监控指标
- API响应时间
- 错误率
- 系统资源使用
- 用户活跃度

## 贡献代码

1. Fork项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交代码 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 提交Pull Request

## 版本历史

- v1.0.0 (2024-01-01)
  - 初始版本发布
  - 实现核心功能

---

更多信息请访问项目文档网站。




